<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>İşlem Giriş Ekranı - Hakan Döviz</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8fafc;
            min-height: 100vh;
        }

        /* Main Layout */
        .main-container {
            display: flex;
            min-height: 100vh;
        }

        .content-area {
            flex: 1;
            padding: 20px 30px;
        }

        .sidebar-panel {
            width: 380px;
            background: white;
            border-left: 1px solid #e2e8f0;
            padding: 20px;
            overflow-y: auto;
        }

        /* Header */
        .page-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
        }

        .back-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: white;
            border: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #64748b;
            cursor: pointer;
        }

        .page-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
        }

        /* Info Card */
        .info-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .info-row {
            display: flex;
            gap: 40px;
            flex-wrap: wrap;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .info-label {
            font-size: 0.75rem;
            color: #64748b;
            text-transform: uppercase;
        }

        .info-value {
            font-size: 0.95rem;
            font-weight: 500;
            color: #1e293b;
        }

        .bakiye-btn {
            padding: 8px 16px;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            color: #64748b;
            font-size: 0.85rem;
            cursor: pointer;
        }

        /* Section Card */
        .section-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            margin-bottom: 15px;
            padding-left: 10px;
            border-left: 3px solid #c9a962;
        }

        /* Form Grid */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-group label {
            font-size: 0.75rem;
            color: #64748b;
            text-transform: uppercase;
        }

        .form-group input,
        .form-group select {
            padding: 10px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.9rem;
            color: #334155;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #c9a962;
        }

        /* Checkbox */
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            color: #334155;
        }

        /* Payment Boxes */
        .payment-boxes {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .payment-box {
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            border-left: 4px solid;
        }

        .payment-box.outgoing {
            border-left-color: #ef4444;
        }

        .payment-box.incoming {
            border-left-color: #22c55e;
        }

        .payment-box-title {
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .payment-box.outgoing .payment-box-title {
            color: #ef4444;
        }

        .payment-box.incoming .payment-box-title {
            color: #22c55e;
        }

        .payment-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            margin-bottom: 8px;
        }

        .payment-row span:first-child {
            color: #64748b;
        }

        .payment-total {
            font-size: 1.1rem;
            font-weight: 600;
            text-align: right;
            padding-top: 10px;
            border-top: 1px solid #e2e8f0;
        }

        .payment-box.outgoing .payment-total {
            color: #ef4444;
        }

        .payment-box.incoming .payment-total {
            color: #22c55e;
        }

        /* Hesaplar Section */
        .hesaplar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .currency-badge {
            padding: 4px 12px;
            background: #c9a962;
            color: white;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .add-hesap-btn {
            padding: 6px 14px;
            background: #22c55e;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .hesap-table {
            width: 100%;
            border-collapse: collapse;
        }

        .hesap-table th {
            padding: 10px;
            text-align: left;
            font-size: 0.75rem;
            color: #64748b;
            text-transform: uppercase;
            border-bottom: 1px solid #e2e8f0;
        }

        .hesap-table td {
            padding: 12px 10px;
            font-size: 0.9rem;
            color: #334155;
        }

        .empty-state {
            text-align: center;
            padding: 20px;
            color: #94a3b8;
            font-size: 0.9rem;
        }

        /* Müşteri Seçim - Custom Dropdown */
        .customer-select-wrapper {
            position: relative;
        }

        .customer-select-trigger {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.9rem;
            color: #334155;
            background: white;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .customer-select-trigger:focus {
            outline: none;
            border-color: #c9a962;
        }

        .customer-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            z-index: 100;
            max-height: 350px;
            overflow-y: auto;
            display: none;
        }

        .customer-dropdown.show {
            display: block;
        }

        .customer-dropdown-header {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            gap: 8px;
        }

        .customer-search {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .customer-filter-tabs {
            display: flex;
            gap: 6px;
        }

        .customer-filter-tab {
            padding: 6px 12px;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            color: #64748b;
        }

        .customer-filter-tab.active {
            background: #c9a962;
            border-color: #c9a962;
            color: white;
        }

        .customer-list {
            padding: 8px 0;
        }

        .customer-item {
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }

        .customer-item:hover {
            background: #f8fafc;
        }

        .customer-item.passive {
            background: #fef2f2;
        }

        .customer-item.passive:hover {
            background: #fee2e2;
        }

        .customer-item-left {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .customer-item-name {
            font-weight: 500;
            color: #1e293b;
            font-size: 0.9rem;
        }

        .customer-item.passive .customer-item-name {
            color: #94a3b8;
        }

        .customer-item-info {
            font-size: 0.8rem;
            color: #64748b;
        }

        .customer-status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .customer-status-badge.active {
            background: #d1fae5;
            color: #059669;
        }

        .customer-status-badge.passive {
            background: #fee2e2;
            color: #dc2626;
        }

        /* Seçilen Müşteri Bilgi Kartı */
        .selected-customer-card {
            margin-top: 15px;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            display: none;
        }

        .selected-customer-card.show {
            display: block;
        }

        .selected-customer-card.active {
            background: #f0fdf4;
            border-color: #bbf7d0;
        }

        .selected-customer-card.passive {
            background: #fef2f2;
            border-color: #fecaca;
        }

        .selected-customer-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .selected-customer-name {
            font-weight: 600;
            font-size: 1rem;
            color: #1e293b;
        }

        .selected-customer-card.passive .selected-customer-name {
            color: #dc2626;
        }

        .selected-customer-details {
            display: flex;
            gap: 20px;
            font-size: 0.85rem;
            color: #64748b;
            margin-bottom: 10px;
        }

        /* Pasif Müşteri Uyarı Kutusu */
        .passive-warning {
            background: #fef3c7;
            border: 1px solid #fcd34d;
            border-radius: 8px;
            padding: 12px;
            margin-top: 10px;
        }

        .passive-warning-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: #92400e;
            margin-bottom: 8px;
        }

        .passive-warning-header i {
            color: #f59e0b;
        }

        .passive-reason {
            font-size: 0.85rem;
            color: #78350f;
            margin-bottom: 6px;
        }

        .passive-date {
            font-size: 0.8rem;
            color: #a16207;
        }

        .continue-anyway-btn {
            margin-top: 10px;
            padding: 8px 16px;
            background: #f59e0b;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
        }

        .continue-anyway-btn:hover {
            background: #d97706;
        }

        /* Summary Row */
        .summary-row {
            display: flex;
            gap: 40px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
            margin-top: 15px;
        }

        .summary-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .summary-label {
            font-size: 0.75rem;
            color: #64748b;
            text-transform: uppercase;
        }

        .summary-value {
            font-size: 1rem;
            font-weight: 600;
        }

        .summary-value.green {
            color: #22c55e;
        }

        .summary-value.red {
            color: #ef4444;
        }

        /* Kaydet Button */
        .kaydet-btn {
            padding: 12px 30px;
            background: #c9a962;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            float: right;
            margin-top: 15px;
        }

        .kaydet-btn:hover {
            background: #b8944f;
        }

        /* ==================== */
        /* SIDEBAR - İşlem Geçmişi */
        /* ==================== */

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .sidebar-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1rem;
            font-weight: 600;
            color: #1e293b;
        }

        .count-badge {
            padding: 2px 10px;
            background: #c9a962;
            color: white;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        .gecmis-btn {
            padding: 8px 14px;
            background: #22c55e;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
        }

        /* Kullanıcı Filtreleme */
        .filter-section {
            margin-bottom: 20px;
        }

        .filter-group {
            margin-bottom: 15px;
        }

        .filter-label {
            font-size: 0.75rem;
            color: #64748b;
            text-transform: uppercase;
            margin-bottom: 8px;
            display: block;
        }

        .filter-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .filter-tab {
            padding: 6px 14px;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 20px;
            font-size: 0.8rem;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-tab:hover {
            background: #e2e8f0;
        }

        .filter-tab.active {
            background: #c9a962;
            border-color: #c9a962;
            color: white;
        }

        /* Kullanıcı Dropdown */
        .user-filter-dropdown {
            position: relative;
            margin-bottom: 15px;
        }

        .user-filter-select {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.9rem;
            color: #334155;
            background: white;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2364748b' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
        }

        .user-filter-select:focus {
            outline: none;
            border-color: #c9a962;
        }

        .son-durum-btn {
            width: 100%;
            padding: 10px;
            background: #22c55e;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            margin-bottom: 15px;
        }

        /* Transaction List */
        .transaction-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .transaction-card {
            background: #f8fafc;
            border-radius: 10px;
            padding: 14px;
            border-left: 4px solid;
            cursor: pointer;
            transition: all 0.2s;
        }

        .transaction-card:hover {
            background: #f1f5f9;
        }

        .transaction-card.satis {
            border-left-color: #c9a962;
        }

        .transaction-card.alis {
            border-left-color: #22c55e;
        }

        .transaction-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .customer-name {
            font-weight: 600;
            color: #1e293b;
            font-size: 0.95rem;
        }

        .type-badge {
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .type-badge.satis {
            background: #fef3c7;
            color: #d97706;
        }

        .type-badge.alis {
            background: #d1fae5;
            color: #059669;
        }

        .transaction-details {
            display: flex;
            gap: 20px;
            font-size: 0.8rem;
            color: #64748b;
            margin-bottom: 10px;
        }

        .transaction-details span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .transaction-details strong {
            color: #334155;
        }

        .transaction-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            color: #94a3b8;
            padding-top: 10px;
            border-top: 1px solid #e2e8f0;
        }

        .transaction-user {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-badge {
            padding: 3px 8px;
            background: #e0e7ff;
            color: #4f46e5;
            border-radius: 4px;
            font-size: 0.7rem;
        }

        /* Zoom Controls */
        .zoom-controls {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }

        .zoom-btn {
            width: 32px;
            height: 32px;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            color: #64748b;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Content Area -->
        <div class="content-area">
            <!-- Header -->
            <div class="page-header">
                <button class="back-btn">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <h1 class="page-title">İşlem Giriş Ekranı</h1>
            </div>

            <!-- Zoom Controls -->
            <div class="zoom-controls">
                <button class="zoom-btn"><i class="fas fa-search-plus"></i></button>
                <button class="zoom-btn"><i class="fas fa-search-minus"></i></button>
                <button class="zoom-btn"><i class="fas fa-expand"></i></button>
                <button class="zoom-btn"><i class="fas fa-arrows-alt-h"></i></button>
            </div>

            <!-- Info Card -->
            <div class="info-card">
                <div class="info-row">
                    <div class="info-item">
                        <span class="info-label">Temsilci</span>
                        <span class="info-value">Meltem Akdilek</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Tarih</span>
                        <span class="info-value">19.01.2026</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Durum</span>
                        <span class="info-value">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Vergi Muaf</span>
                        <span class="info-value">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Bakiye</span>
                        <button class="bakiye-btn">Bakiye Göster</button>
                    </div>
                </div>
            </div>

            <!-- İşlem Bilgileri -->
            <div class="section-card">
                <div class="section-title">İşlem Bilgileri</div>

                <!-- Müşteri Seçimi - Geliştirilmiş -->
                <div class="form-group" style="margin-bottom: 15px; max-width: 400px;">
                    <label>Ünvan</label>
                    <div class="customer-select-wrapper">
                        <div class="customer-select-trigger" onclick="toggleCustomerDropdown()">
                            <span id="selectedCustomerText">Müşteri seçiniz...</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="customer-dropdown" id="customerDropdown">
                            <div class="customer-dropdown-header">
                                <input type="text" class="customer-search" placeholder="Müşteri ara..." onkeyup="filterCustomers(this.value)">
                                <div class="customer-filter-tabs">
                                    <button class="customer-filter-tab active" onclick="filterByStatus('all')">Tümü</button>
                                    <button class="customer-filter-tab" onclick="filterByStatus('active')">Aktif</button>
                                    <button class="customer-filter-tab" onclick="filterByStatus('passive')">Pasif</button>
                                </div>
                            </div>
                            <div class="customer-list" id="customerList">
                                <!-- Aktif Müşteriler -->
                                <div class="customer-item" data-status="active" data-muafiyet="false" onclick="selectCustomer('ufuk', 'Ufuk Doğan', 'active', '', '', false)">
                                    <div class="customer-item-left">
                                        <span class="customer-item-name">Ufuk Doğan</span>
                                        <span class="customer-item-info">TCKN: 12345678901</span>
                                    </div>
                                    <span class="customer-status-badge active">Aktif</span>
                                </div>
                                <div class="customer-item" data-status="active" data-muafiyet="true" onclick="selectCustomer('atlas', 'Atlas Gıda San. Tic. A.Ş.', 'active', '', '', true)">
                                    <div class="customer-item-left">
                                        <span class="customer-item-name">Atlas Gıda San. Tic. A.Ş.</span>
                                        <span class="customer-item-info">VKN: 1234567890</span>
                                    </div>
                                    <div style="display: flex; gap: 6px; align-items: center;">
                                        <span class="customer-status-badge" style="background: #dbeafe; color: #1d4ed8;">Vergi Muaf</span>
                                        <span class="customer-status-badge active">Aktif</span>
                                    </div>
                                </div>
                                <div class="customer-item" data-status="active" data-muafiyet="false" onclick="selectCustomer('guney', 'Güney San. Tic. A.Ş.', 'active', '', '', false)">
                                    <div class="customer-item-left">
                                        <span class="customer-item-name">Güney San. Tic. A.Ş.</span>
                                        <span class="customer-item-info">VKN: 9876543210</span>
                                    </div>
                                    <span class="customer-status-badge active">Aktif</span>
                                </div>
                                <!-- Pasif Müşteriler -->
                                <div class="customer-item passive" data-status="passive" data-muafiyet="false" onclick="selectCustomer('mehmet', 'Mehmet Yılmaz', 'passive', 'Ödeme gecikmeleri nedeniyle pasife alındı', '15.12.2025', false)">
                                    <div class="customer-item-left">
                                        <span class="customer-item-name">Mehmet Yılmaz</span>
                                        <span class="customer-item-info">TCKN: 98765432109</span>
                                    </div>
                                    <span class="customer-status-badge passive">Pasif</span>
                                </div>
                                <div class="customer-item passive" data-status="passive" data-muafiyet="true" onclick="selectCustomer('abc', 'ABC Tekstil Ltd. Şti.', 'passive', 'Şirket faaliyetlerini durdurdu', '01.11.2025', true)">
                                    <div class="customer-item-left">
                                        <span class="customer-item-name">ABC Tekstil Ltd. Şti.</span>
                                        <span class="customer-item-info">VKN: 5555555555</span>
                                    </div>
                                    <div style="display: flex; gap: 6px; align-items: center;">
                                        <span class="customer-status-badge" style="background: #dbeafe; color: #1d4ed8;">Vergi Muaf</span>
                                        <span class="customer-status-badge passive">Pasif</span>
                                    </div>
                                </div>
                                <div class="customer-item passive" data-status="passive" data-muafiyet="false" onclick="selectCustomer('ali', 'Ali Kara', 'passive', 'Müşteri talebiyle pasife alındı', '20.10.2025', false)">
                                    <div class="customer-item-left">
                                        <span class="customer-item-name">Ali Kara</span>
                                        <span class="customer-item-info">TCKN: 11122233344</span>
                                    </div>
                                    <span class="customer-status-badge passive">Pasif</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Seçilen Müşteri Bilgi Kartı -->
                <div class="selected-customer-card" id="selectedCustomerCard">
                    <div class="selected-customer-header">
                        <div>
                            <div class="selected-customer-name" id="selectedCustomerName">-</div>
                            <div class="selected-customer-details">
                                <span id="selectedCustomerTckn">-</span>
                            </div>
                        </div>
                        <div style="display: flex; gap: 6px; align-items: center;">
                            <span class="customer-status-badge" id="selectedCustomerMuafiyetBadge" style="display: none; background: #dbeafe; color: #1d4ed8;">Vergi Muaf</span>
                            <span class="customer-status-badge" id="selectedCustomerBadge">-</span>
                        </div>
                    </div>

                    <!-- Muafiyet Bilgi Kutusu -->
                    <div class="muafiyet-info" id="muafiyetInfo" style="display: none; background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 8px; padding: 10px; margin-bottom: 10px;">
                        <div style="display: flex; align-items: center; gap: 8px; color: #1d4ed8; font-size: 0.85rem;">
                            <i class="fas fa-info-circle"></i>
                            <span>Bu müşteri vergi muafiyetine sahiptir. Satış işlemlerinde BSMV uygulanmayacaktır.</span>
                        </div>
                    </div>

                    <!-- Pasif Müşteri Uyarı Kutusu -->
                    <div class="passive-warning" id="passiveWarning" style="display: none;">
                        <div class="passive-warning-header">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span>Bu müşteri pasif durumda!</span>
                        </div>
                        <div class="passive-reason" id="passiveReason">-</div>
                        <div class="passive-date">
                            <i class="fas fa-calendar-alt" style="margin-right: 5px;"></i>
                            Pasife alınma tarihi: <span id="passiveDate">-</span>
                        </div>
                        <button class="continue-anyway-btn" onclick="continueWithPassive()">
                            <i class="fas fa-arrow-right" style="margin-right: 5px;"></i>
                            Yine de devam et
                        </button>
                    </div>
                </div>

                <div class="form-grid" style="margin-top: 15px;">
                    <div class="form-group" style="width: 60px;">
                        <label>Yeni</label>
                        <button style="padding: 10px; background: #f1f5f9; border: 1px solid #e2e8f0; border-radius: 6px;">+</button>
                    </div>
                    <div class="form-group">
                        <label>İşlem Türü</label>
                        <select id="islemTuru" onchange="onIslemTuruChange()">
                            <option value="">Seçiniz</option>
                            <option value="alis">Alış</option>
                            <option value="satis">Satış</option>
                            <option value="arbitraj">Arbitraj</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Para Birimi</label>
                        <select id="paraBirimi" onchange="calculateBSMV()">
                            <option value="">Seçiniz</option>
                            <option value="USD">USD</option>
                            <option value="EUR">EUR</option>
                            <option value="GBP">GBP</option>
                            <option value="CHF">CHF</option>
                            <option value="JPY">JPY</option>
                            <option value="SAR">SAR</option>
                            <option value="AED">AED</option>
                        </select>
                    </div>
                    <!-- Karşı Döviz - Sadece Arbitraj'da görünür -->
                    <div class="form-group" id="karsiDovizGroup" style="display: none;">
                        <label>Karşı Döviz</label>
                        <select id="karsiDoviz" onchange="calculateBSMV()">
                            <option value="">Seçiniz</option>
                            <option value="USD">USD</option>
                            <option value="EUR">EUR</option>
                            <option value="GBP">GBP</option>
                            <option value="CHF">CHF</option>
                            <option value="JPY">JPY</option>
                            <option value="SAR">SAR</option>
                            <option value="AED">AED</option>
                        </select>
                    </div>
                    <div class="form-group" style="width: 60px;" id="plusBtnGroup">
                        <label>&nbsp;</label>
                        <button style="padding: 10px; background: #f1f5f9; border: 1px solid #e2e8f0; border-radius: 6px;">+</button>
                    </div>
                    <div class="form-group">
                        <label>Miktar</label>
                        <input type="text" id="miktar" value="0" oninput="calculateBSMV()" onchange="calculateBSMV()">
                    </div>
                    <div class="form-group">
                        <label>BSMV</label>
                        <div class="checkbox-group">
                            <label class="checkbox-item">
                                <input type="checkbox" id="bsmvCheckbox" onchange="calculateBSMV()"> <span id="bsmvLabel">BSMV</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="bsmvDahilCheckbox" onchange="calculateBSMV()"> <span id="dahilLabel">Dahil</span>
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>BSMV Tutar</label>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <input type="text" id="bsmvTutar" value="0.00" style="width: 100px; background: #f8fafc;" readonly>
                            <span style="font-size: 0.8rem; color: #64748b;">TL</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Fiyat (Kur)</label>
                        <input type="text" id="fiyatKur" value="0.0000" oninput="calculateBSMV()" onchange="calculateBSMV()">
                    </div>
                    <!-- Karşı Kur - Sadece Arbitraj'da görünür, kullanıcı girer -->
                    <div class="form-group" id="karsiKurGroup" style="display: none;">
                        <label>Karşı Kur</label>
                        <input type="text" id="karsiKur" value="0.0000" oninput="calculateBSMV()" onchange="calculateBSMV()" style="background: #fef3c7; font-weight: 600;">
                    </div>
                    <!-- Çarpan - Otomatik hesaplanır, readonly -->
                    <div class="form-group" id="caprazKurGroup" style="display: none;">
                        <label>Çarpan</label>
                        <input type="text" id="caprazKur" value="0,00000" style="background: #f0fdf4; font-weight: 600;" readonly>
                    </div>
                    <div class="form-group">
                        <label>Valör Tarihi</label>
                        <input type="date" value="2026-01-19">
                    </div>
                </div>

                <!-- Arbitraj İşlem Özeti - Excel Tablo Formatı -->
                <div class="arbitraj-ozet" id="arbitrajOzet" style="display: none; margin-top: 15px;">
                    <!-- Başlık Satırı -->
                    <div style="background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); color: white; padding: 8px 12px; font-weight: 600; font-size: 0.9rem; border-radius: 6px 6px 0 0;">
                        ARBİTRAJ İŞLEM ÖZETİ - 2 AYAKLI İŞLEM
                    </div>

                    <!-- Tablo -->
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem; background: white; border: 1px solid #d1d5db;">
                        <!-- Tablo Başlığı -->
                        <thead>
                            <tr style="background: #374151; color: white;">
                                <th style="padding: 8px 10px; text-align: left; border: 1px solid #4b5563; font-weight: 600;">İŞLEM</th>
                                <th style="padding: 8px 10px; text-align: left; border: 1px solid #4b5563; font-weight: 600;">KODU</th>
                                <th style="padding: 8px 10px; text-align: right; border: 1px solid #4b5563; font-weight: 600;">MİKTAR</th>
                                <th style="padding: 8px 10px; text-align: right; border: 1px solid #4b5563; font-weight: 600;">KUR</th>
                                <th style="padding: 8px 10px; text-align: right; border: 1px solid #4b5563; font-weight: 600;">TUTAR</th>
                                <th style="padding: 8px 10px; text-align: center; border: 1px solid #4b5563; font-weight: 600;">BİRİM</th>
                                <th style="padding: 8px 10px; text-align: right; border: 1px solid #4b5563; font-weight: 600; background: #dc2626;">BSMV</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Satış Satırı (1. Ayak) -->
                            <tr id="arbitrajSatisRow" style="background: #fef2f2;">
                                <td style="padding: 8px 10px; border: 1px solid #e5e7eb;">
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <select id="arbitrajIslem1" style="padding: 4px 8px; border: 1px solid #d1d5db; border-radius: 4px; background: white; font-size: 0.8rem;">
                                            <option value="SATIS" selected>SATIŞ</option>
                                        </select>
                                        <span style="color: #64748b; font-size: 0.75rem;">▼</span>
                                    </div>
                                </td>
                                <td style="padding: 8px 10px; border: 1px solid #e5e7eb;">
                                    <span id="ayak1Kodu" style="font-weight: 600; color: #1e293b;">EUR</span>
                                </td>
                                <td style="padding: 8px 10px; border: 1px solid #e5e7eb; text-align: right; font-family: monospace;">
                                    <span id="ayak1Miktar">0,00</span>
                                </td>
                                <td style="padding: 8px 10px; border: 1px solid #e5e7eb; text-align: right; font-family: monospace;">
                                    <span id="ayak1Kur">0,0000</span>
                                </td>
                                <td style="padding: 8px 10px; border: 1px solid #e5e7eb; text-align: right; font-family: monospace; font-weight: 600;">
                                    <span id="ayak1Tutar">0,00</span>
                                </td>
                                <td style="padding: 8px 10px; border: 1px solid #e5e7eb; text-align: center;">
                                    <span style="font-weight: 600;">TL</span>
                                </td>
                                <td style="padding: 8px 10px; border: 1px solid #e5e7eb; text-align: right; background: #fecaca; font-family: monospace; font-weight: 600; color: #dc2626;">
                                    <span id="ayak1Bsmv">0,00</span>
                                </td>
                            </tr>
                            <!-- Alış Satırı (2. Ayak) -->
                            <tr id="arbitrajAlisRow" style="background: #f0fdf4;">
                                <td style="padding: 8px 10px; border: 1px solid #e5e7eb;">
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <select id="arbitrajIslem2" style="padding: 4px 8px; border: 1px solid #d1d5db; border-radius: 4px; background: white; font-size: 0.8rem;">
                                            <option value="ALIS" selected>ALIŞ</option>
                                        </select>
                                        <span style="color: #64748b; font-size: 0.75rem;">▼</span>
                                    </div>
                                </td>
                                <td style="padding: 8px 10px; border: 1px solid #e5e7eb;">
                                    <span id="ayak2Kodu" style="font-weight: 600; color: #1e293b;">USD</span>
                                </td>
                                <td style="padding: 8px 10px; border: 1px solid #e5e7eb; text-align: right; font-family: monospace;">
                                    <span id="ayak2Miktar">0,00</span>
                                </td>
                                <td style="padding: 8px 10px; border: 1px solid #e5e7eb; text-align: right; font-family: monospace;">
                                    <span id="ayak2Kur">0,0000</span>
                                </td>
                                <td style="padding: 8px 10px; border: 1px solid #e5e7eb; text-align: right; font-family: monospace; font-weight: 600;">
                                    <span id="ayak2Tutar">0,00</span>
                                </td>
                                <td style="padding: 8px 10px; border: 1px solid #e5e7eb; text-align: center;">
                                    <span style="font-weight: 600;">TL</span>
                                </td>
                                <td style="padding: 8px 10px; border: 1px solid #e5e7eb; text-align: right; background: #e5e7eb; font-family: monospace; color: #64748b;">
                                    -
                                </td>
                            </tr>
                        </tbody>
                    </table>

                    <!-- Alt Bilgi -->
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: #f8fafc; border: 1px solid #d1d5db; border-top: none; border-radius: 0 0 6px 6px;">
                        <div style="font-size: 0.8rem; color: #64748b;">
                            <i class="fas fa-info-circle"></i> İşlem kesildiğinde 2 ayrı belge oluşturulur. BSMV sadece satış ayağına uygulanır.
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 0.85rem; color: #374151;">Toplam BSMV:</span>
                            <span id="arbitrajToplamBsmv" style="font-weight: 700; color: #dc2626; font-size: 1rem; background: #fecaca; padding: 4px 10px; border-radius: 4px;">0,00 TL</span>
                        </div>
                    </div>
                </div>

                <!-- Payment Boxes -->
                <div class="payment-boxes">
                    <div class="payment-box outgoing">
                        <div class="payment-box-title">FİRMADAN MÜŞTERİYE ÖDEME</div>
                        <div class="payment-row">
                            <span>Miktar × Kur</span>
                            <span>0 × 0,0000</span>
                        </div>
                        <div class="payment-total">0,00 TRY</div>
                    </div>
                    <div class="payment-box incoming">
                        <div class="payment-box-title">MÜŞTERİDEN FİRMAYA ÖDEME</div>
                        <div class="payment-row">
                            <span>Miktar × Kur</span>
                            <span>0 × 0,0000</span>
                        </div>
                        <div class="payment-total">0,00 TRY</div>
                    </div>
                </div>
            </div>

            <!-- Hesaplar Section -->
            <div class="section-card">
                <div class="hesaplar-header">
                    <div class="section-title" style="margin-bottom: 0;">Firmadan Müşteriye Ödeme Hesapları</div>
                    <div style="display: flex; gap: 10px;">
                        <span class="currency-badge">TRY</span>
                        <button class="add-hesap-btn">
                            <i class="fas fa-plus"></i>
                            Ödeme Hesabı Ekle
                        </button>
                    </div>
                </div>
                <table class="hesap-table">
                    <thead>
                        <tr>
                            <th>Ödeme Banka - IBAN</th>
                            <th>Miktar</th>
                            <th>İşlem</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="3" class="empty-state">Henüz ödeme hesabı eklenmedi</td>
                        </tr>
                    </tbody>
                </table>

                <!-- Summary -->
                <div class="summary-row">
                    <div class="summary-item">
                        <span class="summary-label">Ödenecek Tutar</span>
                        <span class="summary-value green">0,00</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Ödeme Toplamı</span>
                        <span class="summary-value green">0,00</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Kalan</span>
                        <span class="summary-value red">0,00</span>
                    </div>
                </div>

                <button class="kaydet-btn">Kaydet</button>
            </div>
        </div>

        <!-- Sidebar - İşlem Geçmişi -->
        <div class="sidebar-panel">
            <div class="sidebar-header">
                <div class="sidebar-title">
                    İşlem Geçmişi
                    <span class="count-badge">2</span>
                </div>
                <button class="gecmis-btn">Geçmiş İşlemler</button>
            </div>

            <!-- Kullanıcı Filtreleme -->
            <div class="filter-section">
                <div class="filter-group">
                    <span class="filter-label">Temsilci:</span>
                    <select class="user-filter-select" id="userFilter">
                        <option value="all">Tüm Kullanıcılar</option>
                        <option value="meltem" selected>Kendi İşlemlerim</option>
                        <option value="caglar">Çağlar Özyıldırım</option>
                        <option value="ahmet">Ahmet Yılmaz</option>
                        <option value="mehmet">Mehmet Demir</option>
                    </select>
                </div>

                <div class="filter-tabs" style="margin-bottom: 10px;">
                    <span class="filter-tab active">Kendi İşlemlerim</span>
                    <span class="filter-tab">Tüm İşlemler</span>
                </div>

                <button class="son-durum-btn">
                    <i class="fas fa-sync-alt" style="margin-right: 6px;"></i>
                    Son Durum
                </button>
            </div>

            <!-- Durum Filtreleri -->
            <div class="filter-group">
                <span class="filter-label">Durum:</span>
                <div class="filter-tabs">
                    <span class="filter-tab">Tümü</span>
                    <span class="filter-tab active">Oluşturuldu</span>
                    <span class="filter-tab">Teslim Edildi</span>
                    <span class="filter-tab">Gönderildi</span>
                    <span class="filter-tab">Tamamlandı</span>
                    <span class="filter-tab">Ödemeye Hazır</span>
                </div>
            </div>

            <!-- İşlem Türü Filtreleri -->
            <div class="filter-group">
                <span class="filter-label">İşlem:</span>
                <div class="filter-tabs">
                    <span class="filter-tab active">Tümü</span>
                    <span class="filter-tab">Alış</span>
                    <span class="filter-tab">Satış</span>
                    <span class="filter-tab">Valör</span>
                </div>
            </div>

            <!-- Transaction List -->
            <div class="transaction-list">
                <!-- Transaction 1 -->
                <div class="transaction-card satis">
                    <div class="transaction-card-header">
                        <span class="customer-name">Ufuk Doğan</span>
                        <span class="type-badge satis">SATIŞ</span>
                    </div>
                    <div class="transaction-details">
                        <span><strong>Mkt:</strong> 500,00 USD</span>
                        <span><strong>Kur:</strong> 48,0000</span>
                        <span><strong>Tutar:</strong> 24.048,00 TRY</span>
                    </div>
                    <div class="transaction-footer">
                        <div class="transaction-user">
                            <span>13:25</span>
                            <span>Meltem Akdilek</span>
                        </div>
                        <span class="status-badge">Oluşturuldu</span>
                    </div>
                </div>

                <!-- Transaction 2 -->
                <div class="transaction-card alis">
                    <div class="transaction-card-header">
                        <span class="customer-name">Ufuk Doğan</span>
                        <span class="type-badge alis">ALIŞ</span>
                    </div>
                    <div class="transaction-details">
                        <span><strong>Mkt:</strong> 9.980,00 TRY</span>
                        <span><strong>Kur:</strong> 50,0000</span>
                        <span><strong>Tutar:</strong> 9.980,00 EUR</span>
                    </div>
                    <div class="transaction-footer">
                        <div class="transaction-user">
                            <span>13:24</span>
                            <span>Meltem Akdilek</span>
                        </div>
                        <span class="status-badge">Oluşturuldu</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global değişkenler - EN BAŞTA tanımlanmalı
        let musteriMuafiyet = false;

        // Filter tabs toggle
        document.querySelectorAll('.filter-tabs').forEach(tabGroup => {
            tabGroup.querySelectorAll('.filter-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    tabGroup.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                });
            });
        });

        // User filter change
        document.getElementById('userFilter').addEventListener('change', function() {
            const selectedUser = this.value;
            console.log('Filtering by user:', selectedUser);
        });

        // ==================== MÜŞTERİ SEÇİM FONKSİYONLARI ====================

        // Dropdown aç/kapa
        function toggleCustomerDropdown() {
            const dropdown = document.getElementById('customerDropdown');
            dropdown.classList.toggle('show');
        }

        // Dropdown dışına tıklanınca kapat
        document.addEventListener('click', function(e) {
            const wrapper = document.querySelector('.customer-select-wrapper');
            if (wrapper && !wrapper.contains(e.target)) {
                document.getElementById('customerDropdown').classList.remove('show');
            }
        });

        // Müşteri ara
        function filterCustomers(searchText) {
            const items = document.querySelectorAll('.customer-item');
            searchText = searchText.toLowerCase();

            items.forEach(item => {
                const name = item.querySelector('.customer-item-name').textContent.toLowerCase();
                const info = item.querySelector('.customer-item-info').textContent.toLowerCase();

                if (name.includes(searchText) || info.includes(searchText)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Duruma göre filtrele (Tümü / Aktif / Pasif)
        function filterByStatus(status) {
            const tabs = document.querySelectorAll('.customer-filter-tab');
            tabs.forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            const items = document.querySelectorAll('.customer-item');
            items.forEach(item => {
                const itemStatus = item.dataset.status;
                if (status === 'all' || itemStatus === status) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Müşteri seç
        function selectCustomer(id, name, status, passiveReason = '', passiveDate = '', vergiMuaf = false) {
            // Dropdown'u kapat
            document.getElementById('customerDropdown').classList.remove('show');

            // Seçili müşteri metnini güncelle
            document.getElementById('selectedCustomerText').textContent = name;

            // Müşteri kartını göster
            const card = document.getElementById('selectedCustomerCard');
            card.classList.add('show');
            card.classList.remove('active', 'passive');
            card.classList.add(status);

            // Müşteri bilgilerini doldur
            document.getElementById('selectedCustomerName').textContent = name;

            // Badge güncelle
            const badge = document.getElementById('selectedCustomerBadge');
            badge.textContent = status === 'active' ? 'Aktif' : 'Pasif';
            badge.className = 'customer-status-badge ' + status;

            // Muafiyet badge ve info kutusu
            const muafiyetBadge = document.getElementById('selectedCustomerMuafiyetBadge');
            const muafiyetInfo = document.getElementById('muafiyetInfo');
            if (vergiMuaf) {
                muafiyetBadge.style.display = 'inline-block';
                muafiyetInfo.style.display = 'block';
            } else {
                muafiyetBadge.style.display = 'none';
                muafiyetInfo.style.display = 'none';
            }

            // Müşteri muafiyet durumunu global değişkene kaydet
            musteriMuafiyet = vergiMuaf;

            // Pasif müşteri ise uyarı göster
            const passiveWarning = document.getElementById('passiveWarning');
            if (status === 'passive') {
                passiveWarning.style.display = 'block';
                document.getElementById('passiveReason').textContent = passiveReason;
                document.getElementById('passiveDate').textContent = passiveDate;
            } else {
                passiveWarning.style.display = 'none';
            }

            // BSMV kurallarını güncelle
            applyBSMVRules();
            calculateBSMV();
        }

        // Pasif müşteriyle devam et
        function continueWithPassive() {
            const warning = document.getElementById('passiveWarning');
            warning.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px; color: #059669;">
                    <i class="fas fa-check-circle"></i>
                    <span>Pasif müşteriyle işleme devam ediliyor</span>
                </div>
            `;
            warning.style.background = '#d1fae5';
            warning.style.borderColor = '#6ee7b7';
        }

        // ==================== BSMV VE ARBİTRAJ FONKSİYONLARI ====================

        // BSMV Oranı (binde)
        const BSMV_ORAN = 2; // ‰2

        // Türkçe ve İngilizce sayı formatını akıllıca parse et
        function parseNumber(value) {
            if (!value) return 0;
            let str = String(value).trim();

            // Hem nokta hem virgül varsa: Türkçe format (1.234,56 veya 1.234.567,89)
            if (str.includes('.') && str.includes(',')) {
                // Noktalar binlik, virgül ondalık
                str = str.replace(/\./g, '').replace(',', '.');
            }
            // Sadece virgül varsa: Türkçe ondalık (51,22)
            else if (str.includes(',') && !str.includes('.')) {
                str = str.replace(',', '.');
            }
            // Sadece nokta varsa: İngilizce format olabilir (51.22) veya Türkçe binlik (1.000)
            else if (str.includes('.') && !str.includes(',')) {
                // Noktadan sonra 3 rakam varsa ve tek nokta varsa, Türkçe binlik olabilir
                const parts = str.split('.');
                if (parts.length === 2 && parts[1].length === 3 && parts[0].length <= 3) {
                    // Muhtemelen Türkçe binlik: 1.000 → 1000
                    str = str.replace('.', '');
                }
                // Aksi halde İngilizce ondalık olarak kabul et (51.22 → 51.22)
            }

            return parseFloat(str) || 0;
        }

        // İşlem türü değiştiğinde
        function onIslemTuruChange() {
            const islemTuru = document.getElementById('islemTuru').value;
            const karsiDovizGroup = document.getElementById('karsiDovizGroup');
            const plusBtnGroup = document.getElementById('plusBtnGroup');
            const arbitrajOzet = document.getElementById('arbitrajOzet');
            const caprazKurGroup = document.getElementById('caprazKurGroup');

            // Arbitraj seçildiğinde karşı döviz, karşı kur ve çarpan alanlarını göster
            const karsiKurGroup = document.getElementById('karsiKurGroup');

            if (islemTuru === 'arbitraj') {
                karsiDovizGroup.style.display = 'block';
                karsiKurGroup.style.display = 'block';
                caprazKurGroup.style.display = 'block';
                plusBtnGroup.style.display = 'none';
                arbitrajOzet.style.display = 'block';
            } else {
                karsiDovizGroup.style.display = 'none';
                karsiKurGroup.style.display = 'none';
                caprazKurGroup.style.display = 'none';
                plusBtnGroup.style.display = 'block';
                arbitrajOzet.style.display = 'none';
            }

            // BSMV kurallarını uygula
            applyBSMVRules();
            calculateBSMV();
            updateArbitrajOzet();
        }

        // BSMV kurallarını uygula
        function applyBSMVRules() {
            const islemTuru = document.getElementById('islemTuru').value;
            const bsmvCheckbox = document.getElementById('bsmvCheckbox');
            const bsmvDahilCheckbox = document.getElementById('bsmvDahilCheckbox');
            const bsmvTutarInput = document.getElementById('bsmvTutar');

            // Muafiyet durumunu kontrol et - seçili müşteriden badge'e bak
            const muafiyetBadge = document.getElementById('selectedCustomerMuafiyetBadge');
            const isMuafFromBadge = muafiyetBadge && muafiyetBadge.style.display === 'inline-block';

            // Her iki kaynaktan da muafiyet kontrolü
            const hasMuafiyet = musteriMuafiyet === true || isMuafFromBadge === true;

            console.log('=== applyBSMVRules ===');
            console.log('İşlem Türü:', islemTuru);
            console.log('musteriMuafiyet:', musteriMuafiyet);
            console.log('isMuafFromBadge:', isMuafFromBadge);
            console.log('hasMuafiyet (final):', hasMuafiyet);

            // Önce mevcut durumu temizle
            bsmvCheckbox.removeAttribute('checked');
            bsmvDahilCheckbox.removeAttribute('checked');

            if (islemTuru === 'alis') {
                // ALIŞ İŞLEMLERİNDE BSMV HER ZAMAN KAPALI VE DİSABLED
                bsmvCheckbox.checked = false;
                bsmvCheckbox.disabled = true;
                bsmvDahilCheckbox.checked = false;
                bsmvDahilCheckbox.disabled = true;
                bsmvTutarInput.value = '0,00';
                bsmvTutarInput.style.background = '#f8fafc';
                bsmvTutarInput.style.color = '#64748b';
                bsmvTutarInput.style.fontWeight = 'normal';
                // Görsel olarak devre dışı göster
                bsmvCheckbox.parentElement.style.opacity = '0.5';
                bsmvDahilCheckbox.parentElement.style.opacity = '0.5';
                console.log('>>> ALIŞ: BSMV kapatıldı ve disabled yapıldı');
            } else if (islemTuru === 'satis' || islemTuru === 'arbitraj') {
                // Satış/Arbitraj işlemlerinde muafiyet kontrolü
                if (hasMuafiyet) {
                    // MUAFİYET VARSA: BSMV kapalı VE SEÇİLEMEZ (disabled)
                    bsmvCheckbox.checked = false;
                    bsmvCheckbox.disabled = true;  // Seçilemez yap
                    bsmvDahilCheckbox.checked = false;
                    bsmvDahilCheckbox.disabled = true;  // Seçilemez yap
                    bsmvTutarInput.value = '0,00';
                    bsmvTutarInput.style.background = '#f8fafc';
                    bsmvTutarInput.style.color = '#64748b';
                    // Görsel olarak devre dışı göster
                    bsmvCheckbox.parentElement.style.opacity = '0.5';
                    bsmvDahilCheckbox.parentElement.style.opacity = '0.5';
                    console.log('>>> SATIŞ/ARBİTRAJ + MUAFİYET VAR: BSMV kapalı ve disabled');
                } else {
                    // MUAFİYET YOKSA: BSMV açık ve seçilebilir
                    bsmvCheckbox.checked = true;
                    bsmvCheckbox.disabled = false;
                    bsmvDahilCheckbox.disabled = false;
                    // Görsel olarak aktif göster
                    bsmvCheckbox.parentElement.style.opacity = '1';
                    bsmvDahilCheckbox.parentElement.style.opacity = '1';
                    console.log('>>> SATIŞ/ARBİTRAJ + MUAFİYET YOK: BSMV açık');
                }
            } else {
                // Seçim yapılmamış - varsayılan durum
                bsmvCheckbox.checked = false;
                bsmvCheckbox.disabled = true;
                bsmvDahilCheckbox.checked = false;
                bsmvDahilCheckbox.disabled = true;
                bsmvCheckbox.parentElement.style.opacity = '0.5';
                bsmvDahilCheckbox.parentElement.style.opacity = '0.5';
                console.log('>>> İşlem türü seçilmemiş: BSMV disabled');
            }

            // Final kontrol - DOM güncellendi mi?
            console.log('>>> Checkbox durumları - BSMV:', bsmvCheckbox.checked, '| Dahil:', bsmvDahilCheckbox.checked);
        }

        // BSMV tutarını hesapla
        function calculateBSMV() {
            const islemTuru = document.getElementById('islemTuru').value;
            const bsmvCheckbox = document.getElementById('bsmvCheckbox');
            const miktar = parseNumber(document.getElementById('miktar').value);
            const kur = parseNumber(document.getElementById('fiyatKur').value);
            const bsmvTutarInput = document.getElementById('bsmvTutar');

            // İşlem tutarı (TL cinsinden)
            const islemTutari = miktar * kur;

            // BSMV hesapla
            let bsmvTutar = 0;
            if (bsmvCheckbox.checked && (islemTuru === 'satis' || islemTuru === 'arbitraj')) {
                bsmvTutar = islemTutari * (BSMV_ORAN / 1000);
            }

            // BSMV tutarını göster
            bsmvTutarInput.value = bsmvTutar.toLocaleString('tr-TR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });

            // BSMV durumuna göre input stilini değiştir
            if (bsmvCheckbox.checked && bsmvTutar > 0) {
                bsmvTutarInput.style.background = '#fef2f2';
                bsmvTutarInput.style.color = '#dc2626';
                bsmvTutarInput.style.fontWeight = '600';
            } else {
                bsmvTutarInput.style.background = '#f8fafc';
                bsmvTutarInput.style.color = '#64748b';
                bsmvTutarInput.style.fontWeight = 'normal';
            }

            updateArbitrajOzet();
        }

        // Arbitraj özet bilgilerini güncelle (Excel tablo formatı)
        // Mantık: Kullanıcı SATIŞ miktarı, SATIŞ kuru ve KARŞI KUR (alış kuru) girer
        // Sistem otomatik olarak ÇARPAN ve ALIŞ miktarını hesaplar
        function updateArbitrajOzet() {
            const islemTuru = document.getElementById('islemTuru').value;
            if (islemTuru !== 'arbitraj') return;

            const paraBirimi = document.getElementById('paraBirimi').value || '???';
            const karsiDoviz = document.getElementById('karsiDoviz').value || '???';
            const satisMiktar = parseNumber(document.getElementById('miktar').value);    // Satış miktarı (kullanıcı girer)
            const satisKur = parseNumber(document.getElementById('fiyatKur').value);     // Satış kuru EUR/TL (kullanıcı girer)
            const alisKur = parseNumber(document.getElementById('karsiKur').value);      // Alış kuru USD/TL (kullanıcı girer)
            const bsmvCheckbox = document.getElementById('bsmvCheckbox');

            // Çarpan hesapla: Satış Kuru / Alış Kuru = EUR/USD
            // Örn: 37,2875 / 35,8171 = 1,04105
            const carpan = alisKur > 0 ? satisKur / alisKur : 0;

            // Çarpan input'unu güncelle
            document.getElementById('caprazKur').value = carpan.toLocaleString('tr-TR', {
                minimumFractionDigits: 5,
                maximumFractionDigits: 5
            });

            // AYAK 1: Satış işlemi (Ana döviz satılır → TL alınır)
            // Örn: 100.000 EUR × 37,2875 = 3.728.750 TL
            const ayak1Tutar = satisMiktar * satisKur;

            // BSMV hesaplama (sadece satış ayağına uygulanır)
            let bsmvTutar = 0;
            if (bsmvCheckbox.checked) {
                bsmvTutar = ayak1Tutar * (BSMV_ORAN / 1000);
            }

            // AYAK 2: Alış işlemi hesaplamaları
            // TL tutarı aynı kalır, alış miktarı = TL tutarı / Alış kuru
            // Örn: 3.728.750 / 35,8171 = 104.105 USD
            const ayak2Tutar = ayak1Tutar;
            const alisMiktar = alisKur > 0 ? ayak2Tutar / alisKur : 0;

            // Sayı formatı
            const formatNumber = (num, decimals = 2) => num.toLocaleString('tr-TR', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            });

            // Ayak 1 (Satış) tablo hücrelerini güncelle
            document.getElementById('ayak1Kodu').textContent = paraBirimi;
            document.getElementById('ayak1Miktar').textContent = formatNumber(satisMiktar);
            document.getElementById('ayak1Kur').textContent = formatNumber(satisKur, 4);
            document.getElementById('ayak1Tutar').textContent = formatNumber(ayak1Tutar);
            document.getElementById('ayak1Bsmv').textContent = bsmvCheckbox.checked ? formatNumber(bsmvTutar) : '-';

            // Ayak 2 (Alış) tablo hücrelerini güncelle
            document.getElementById('ayak2Kodu').textContent = karsiDoviz;
            document.getElementById('ayak2Miktar').textContent = formatNumber(alisMiktar);
            document.getElementById('ayak2Kur').textContent = formatNumber(alisKur, 4);
            document.getElementById('ayak2Tutar').textContent = formatNumber(ayak2Tutar);

            // Toplam BSMV
            document.getElementById('arbitrajToplamBsmv').textContent = bsmvCheckbox.checked
                ? `${formatNumber(bsmvTutar)} TL`
                : '0,00 TL';

            console.log('=== Arbitraj Hesaplama ===');
            console.log('Satış:', satisMiktar, paraBirimi, '× Kur:', satisKur, '=', ayak1Tutar, 'TL');
            console.log('Karşı Kur:', alisKur, '→ Çarpan:', carpan);
            console.log('Alış:', alisMiktar, karsiDoviz, '× Kur:', alisKur, '=', ayak2Tutar, 'TL');
            console.log('BSMV:', bsmvTutar);
        }

        // Sayfa yüklendiğinde
        document.addEventListener('DOMContentLoaded', function() {
            applyBSMVRules();
        });
    </script>
</body>
</html>
